#!/usr/bin/env bash

set -o errexit \
    -o xtrace

# build MININIM
mv build-aux/texinfo.tex{,.bkp} || :
autoreconf --install --force
mv build-aux/texinfo.tex{.bkp,}
if [ "$1" == "debug" ]; then
    ./configure --enable-debug
else
    ./configure
fi
make clean
make -j4

# build documentation
cd doc
make mininim.pdf
cd ..

VERSION=$(grep --perl-regexp \
	       --only-matching \
	       '#define VERSION "\K.*?(?=")' \
	       config.h)-gnu-linux-$(uname --machine)

if [ "$1" == "debug" ]; then
    release_dir=release/mininim-$VERSION-debug
else
    release_dir=release/mininim-$VERSION
fi

exe_dir="$release_dir"/mininim.exe
lib_dir="$exe_dir"/lib

# create directory structure
rm --recursive \
   --force \
   --verbose \
   "$release_dir"
mkdir --parents \
      "$lib_dir"

# function to output library dependencies of executables
function libdep () {
    ldd "$@" |
	grep --only-matching '\W/[^ ]*' |
	sort --unique
}

# copy MININIM and its dependencies
cp mininim \
   $(libdep mininim) \
   "$lib_dir"

# strip binaries if not debug release
if [ "$1" != "debug" ]; then
    strip --strip-all \
	  "$lib_dir"/*
fi

# copy Allegro configuration
cp allegro5.cfg "$lib_dir"

# copy init script
cat > "$exe_dir"/mininim <<'EOF'
#!/usr/bin/env sh
set -e
app_path="$(dirname "$(readlink -f "$0")")"
cd $USER_PWD
LD_LIBRARY_PATH="$app_path"/lib "$app_path"/lib/ld* \
  --library-path "$app_path"/lib \
  "$app_path"/lib/mininim "$@"
EOF

# make it executable
chmod +x \
      "$exe_dir"/mininim

# make self-extracting executable
makeself --xz \
	 --complevel 9 \
	 --noprogress \
	 --nox11 \
	 --nowait \
	 --nomd5 \
	 --nocrc \
	 "$exe_dir" \
	 "$release_dir"/mininim \
	 "MININIM" \
	 ./mininim

# delete intermediate executable files
rm --recursive \
   --verbose \
   "$exe_dir"

# copy data
cp --recursive \
   --verbose \
   data \
   "$release_dir"

# copy documentation
cp doc/mininim.pdf \
   "$release_dir"

# create package
cd release
tar --create \
    --exclude-backup \
    --verbose \
    "$(basename "$release_dir")" |
    xz -9 > "$(basename "$release_dir")".tar.xz
cd ..

# remove temporary release directory
rm --recursive \
   --verbose \
   "$release_dir"
